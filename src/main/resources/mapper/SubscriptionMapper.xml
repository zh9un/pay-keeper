<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.springboot.paykeeper.mapper.SubscriptionMapper">

    <!-- ===========================
         ResultMap Definitions
         =========================== -->

    <!-- PartyMember ResultMap -->
    <resultMap id="PartyMemberResultMap" type="PartyMemberDO">
        <id property="memberSeq" column="member_seq"/>
        <result property="subSeq" column="sub_seq"/>
        <result property="memberName" column="member_name"/>
        <result property="perPrice" column="per_price"/>
        <result property="isPaid" column="is_paid"/>
    </resultMap>

    <!-- Subscription ResultMap with 1:N Collection (파티원 포함) -->
    <!-- NESTED SELECT 방식으로 변경하여 N+1 문제 발생 가능성 있으나, 데이터 정합성을 위해 수정 -->
    <resultMap id="SubscriptionWithMembersResultMap" type="SubscriptionDO">
        <id property="seq" column="seq"/>
        <result property="serviceName" column="service_name"/>
        <result property="totalPrice" column="total_price"/>
        <result property="billingDate" column="billing_date"/>
        <result property="accountNumber" column="account_number"/>
        <result property="shareUuid" column="share_uuid"/>
        <result property="regdate" column="regdate"/>

        <!-- 1:N Collection Mapping using a nested select -->
        <collection property="members"
                    column="seq"
                    ofType="PartyMemberDO"
                    select="selectPartyMembersForSubscription"/>
    </resultMap>

    <!-- ===========================
         CREATE Operations
         =========================== -->

    <!-- 구독 등록 (useGeneratedKeys로 seq 자동 반환, UUID 자동 생성) -->
    <insert id="insertSubscription" parameterType="SubscriptionDO"
            useGeneratedKeys="true" keyProperty="seq" keyColumn="seq">
        INSERT INTO subscription (service_name, total_price, billing_date, account_number, share_uuid)
        VALUES (#{serviceName}, #{totalPrice}, #{billingDate}, #{accountNumber}, UUID())
    </insert>

    <!-- 파티원 일괄 등록 (foreach 배치 삽입) -->
    <insert id="insertPartyMembers" parameterType="list">
        INSERT INTO party_member (sub_seq, member_name, per_price, is_paid)
        VALUES
        <foreach collection="list" item="member" separator=",">
            (#{member.subSeq}, #{member.memberName}, #{member.perPrice}, #{member.isPaid})
        </foreach>
    </insert>

    <!-- ===========================
         READ Operations
         =========================== -->

    <!-- Nested Select용 파티원 조회 쿼리 -->
    <select id="selectPartyMembersForSubscription" parameterType="int" resultMap="PartyMemberResultMap">
        SELECT member_seq, sub_seq, member_name, per_price, is_paid
        FROM party_member
        WHERE sub_seq = #{subSeq}
        ORDER BY member_seq ASC
    </select>

    <!-- 전체 구독 목록 조회 -->
    <select id="selectAll" resultMap="SubscriptionWithMembersResultMap">
        SELECT * FROM subscription ORDER BY seq DESC
    </select>

    <!-- 특정 구독 조회 -->
    <select id="selectOne" parameterType="int" resultMap="SubscriptionWithMembersResultMap">
        SELECT * FROM subscription WHERE seq = #{seq}
    </select>

    <!-- 동적 SQL 검색 (MyBatis <if> 태그 사용) -->
    <select id="searchSubscriptions" resultMap="SubscriptionWithMembersResultMap">
        SELECT s.*
        FROM subscription s
        <where>
            <if test="searchType == 'service' and keyword != null and keyword != ''">
                UPPER(s.service_name) LIKE CONCAT('%', UPPER(#{keyword}), '%')
            </if>
            <if test="searchType == 'member' and keyword != null and keyword != ''">
                s.seq IN (
                    SELECT DISTINCT pm.sub_seq
                    FROM party_member pm
                    WHERE UPPER(pm.member_name) LIKE CONCAT('%', UPPER(#{keyword}), '%')
                )
            </if>
        </where>
        ORDER BY s.seq DESC
    </select>

    <!-- UUID로 구독 조회 (게스트 공유 링크용) -->
    <select id="selectByUuid" parameterType="string" resultMap="SubscriptionWithMembersResultMap">
        SELECT * FROM subscription WHERE share_uuid = #{uuid}
    </select>

    <!-- ===========================
         UPDATE Operations
         =========================== -->

    <!-- 입금 상태 토글 -->
    <update id="updatePaidStatus">
        UPDATE party_member
        SET is_paid = #{newStatus}
        WHERE member_seq = #{memberSeq}
    </update>

    <!-- 파티원 정보 수정 -->
    <update id="updatePartyMember" parameterType="PartyMemberDO">
        UPDATE party_member
        SET member_name = #{memberName},
            per_price = #{perPrice},
            is_paid = #{isPaid}
        WHERE member_seq = #{memberSeq}
    </update>

    <!-- 구독 정보 수정 -->
    <update id="updateSubscription" parameterType="SubscriptionDO">
        UPDATE subscription
        SET service_name = #{serviceName},
            total_price = #{totalPrice},
            billing_date = #{billingDate},
            account_number = #{accountNumber}
        WHERE seq = #{seq}
    </update>

    <!-- UUID 업데이트 (기존 데이터 마이그레이션용) -->
    <update id="updateShareUuid">
        UPDATE subscription
        SET share_uuid = #{uuid}
        WHERE seq = #{seq}
    </update>

    <!-- ===========================
         DELETE Operations
         =========================== -->

    <!-- 구독 삭제 (CASCADE로 파티원도 자동 삭제) -->
    <delete id="deleteSubscription" parameterType="int">
        DELETE FROM subscription
        WHERE seq = #{seq}
    </delete>

    <!-- 파티원 삭제 -->
    <delete id="deletePartyMember" parameterType="int">
        DELETE FROM party_member
        WHERE member_seq = #{memberSeq}
    </delete>

    <!-- 특정 구독의 모든 파티원 삭제 (Update 시 사용) -->
    <delete id="deletePartyMembersBySubSeq" parameterType="int">
        DELETE FROM party_member
        WHERE sub_seq = #{subSeq}
    </delete>

    <!-- ===========================
         UTILITY Operations
         =========================== -->

    <!-- 전체 구독 수 조회 -->
    <select id="countSubscriptions" resultType="int">
        SELECT COUNT(*) FROM subscription
    </select>

    <!-- 특정 구독의 파티원 수 조회 -->
    <select id="countPartyMembers" parameterType="int" resultType="int">
        SELECT COUNT(*) FROM party_member
        WHERE sub_seq = #{subSeq}
    </select>

    <!-- 총 월 결제액 합계 조회 -->
    <select id="sumTotalPrice" resultType="int">
        SELECT COALESCE(SUM(total_price), 0) FROM subscription
    </select>

    <!-- 전체 파티원 수 조회 -->
    <select id="countAllPartyMembers" resultType="int">
        SELECT COUNT(*) FROM party_member
    </select>

    <!-- 입금 완료 파티원 수 조회 -->
    <select id="countPaidPartyMembers" resultType="int">
        SELECT COUNT(*) FROM party_member WHERE is_paid = 'Y'
    </select>

</mapper>
